% !TeX program = XeLaTeX
% !TeX root = main.tex
% Edit by:
\setcounter{chapter}{7}
\chapter{方差分析与回归分析}\label{cha:8}

\section{方差分析}\label{sec:8.1}
\subsection{问题的提出}
前面几章我们讨论的都是一个总体或者两个总体的统计分析问题, 在实际工作中我们还会经常碰到多个总体均值的比较问题, 处理这类问题通常采用所谓的方差分析方法. 本节将叙述这个方法, 先看一个例子. 

\begin{example}\label{exam:8.1.1}
在饲料养鸡增肥的研究中, 某研究所提出三种饲料配方：$A_1$ 是以鱼粉为主的饲料, $A_2$ 是以槐树粉为主的饲料, $A_3$ 是以苜蓿粉为主的饲料. 为比较三种饲料的效果, 特选 24 只相似的雏鸡随机均分为三组, 每组各喂一种饲料, 60 天后观察它们的重量. 试验结果如下表所示：

\begin{table}[htbp]
  \centering
  \caption{鸡饲料试验数据}
    \begin{tabular}{c|rrrrrrrr}
    \toprule
    饲料 $A$   & \multicolumn{7}{c}{鸡重/\si{\gram}                     } &      \\
    \midrule
    $A_1$  & 1073  & 1009  & 1060  & 1001  & 1002  & 1012  & 1009  & 1028 \\
    $A_2$  & 1107  & 1092  & 990   & 1109  & 1090  & 1074  & 1122  & 1001 \\
    $A_3$  & 1093  & 1029  & 1080  & 1021  & 1022  & 1032  & 1029  & 1048 \\
    \bottomrule
    \end{tabular}%
  \label{tab:8.1.1}%
\end{table}%
\end{example}

本例~\ref{exam:8.1.1} 中, 我们要比较的是三种饲料对鸡的增肥作用是否相同. 为此, 把饲料称为\textbf{因子}\index{Y!因子}, 记为 $A$, 三种不同的配方称为因子 $A$ 的三个水平, 记为 $A_1$, $A_2$, $A_3$, 使用配方 $A_i$ 下第 $j$ 只鸡 60 天后的重量用 $y_{ij}$ 表示, $i = 1,2,3$, $j =1,2,3,\ldots,10$. 我们的目的是比较三种不同饲料配方下鸡的平均重量是否相等, 为此, 需要做一些基本假定, 把所研究的问题归结为一个统计问题, 然后用方差分析的方法进行解决. 

在例~\ref{exam:8.1.1} 中, 我们只考察了一个因子, 称其为单因子试验. 通常, 在单因子试验中, 记因子为 $A$, 设其有 $r$ 个水平, 记为 $A_1,A_2,\ldots,A_r$, 在每一水平下考察的指标可以看成一个总体, 现有 $r$ 个水平, 故有 $r$ 个总体, 假定：

\begin{enumerate}
  \item 每一总体均为正态分布, 记为 $N(\mu_i, \sigma_i^2)$, $i=1,\ldots,r$；\label{enu:8.1.2.1}
  \item 各总体的方差相同, 记为 $\sigma_1^2 = \sigma_2^2=\cdots=\sigma_r^2=\sigma^2$；\label{enu:8.1.2.2}
  \item 从每一总体中抽取的样本是相互独立的, 即所有的试验结果 $y_{ij}$ 都相互独立. 
\end{enumerate}

这三个假定都可以用统计方法进行验证. 譬如, 利用正态性检验（7.4.3 节）验证~\ref{enu:8.1.2.1} 成立；利用后面~\ref{sec:8.3} 的方差齐次性检验验证~\ref{enu:8.1.2.2} 成立；而试验结果 $y_{ij}$ 的独立性可由随机化实现, 这里的随机化是指所有试验按随机次序进行. 

我们要做的工作是比较各水平下的均值是否相同, 即要对如下的一个假设进行检验, 
\begin{equation}
  H_0 \text{：} \mu_1 = \mu_2 = \cdots = \mu_r,\label{eq:8.1.1}
\end{equation}
其备择假设为
\begin{equation*}
  H_1 \text{ : } \mu_1,\mu_2,\ldots,\mu_r \text{ 不全相等, }
\end{equation*}
在不会引起误解的情况下, $H_1$ 通常可省略不写. 

如果 $H_0$ 成立, 因子 $A$ 的 $r$ 个水平均值相同, 称因子 $A$ 的 $r$ 个水平间没有显著差异, 简称因子 $A$ \textbf{不显著}\index{B!不显著}；反之, 当 $H_0$ 不成立时, 因子 $A$ 的 $r$ 个水平均值不全相同, 这时称因子 $A$ 的不同水平间有显著差异, 简称因子 $A$ \textbf{显著}\index{X!显著}. 

为对假设~(\ref{eq:8.1.1}) 进行检验, 需要从每一水平下的总体抽取样本, 设从第 $i$ 个水平下的总体获得 $m$ 个试验结果（简单起见, 这里先假设个水平下试验的重复数相同, 后面会看到, 重复数不同时的处理方式与此基本一致, 略有差异）,记 $y_{ij}$ 表示第 $i$ 个总体的第 $j$ 次重复试验结果. 共得到如下 $r \times m$ 个试验结果:
\begin{equation*}
  y_{ij}, \; i=1,2,\ldots,r, \; j = 1,2,\ldots,m,
\end{equation*}
其中 $r$ 为水平数, $m$ 为重复数, $i$ 为水平编号, $j$ 为重复编号.

在水平 $A_i$ 下的试验结果 $y_{ij}$ 与该水平下的指标均值 $\mu_i$ 一般总是有差距的, 记 $\varepsilon_{ij} = y_{ij} - \mu_i$, $\varepsilon_{ij}$ 称为随机误差. 于是有
\begin{equation}
  \label{eq:8.1.2}
  y_{ij} = \mu_i + \varepsilon_{ij}
\end{equation}

~(\ref{eq:8.1.2}) 式称为试验结果 $y_{ij}$ 的\textbf{数据结构式}\index{S!数据结构式}. 把三个假定用子数据结构式就可以写出单因子方差分析的统计模型：
\begin{equation}
  \label{eq:8.1.3}
  \begin{cases}
    y_{ij}  = \mu_i + \varepsilon_{ij}, \; i = 1,2,\ldots,r,\; j = 1,2,\ldots,m; \\
    \text{诸 $\varepsilon_{ij}$ 相互独立, 且都服从 $N(0,\sigma^2)$ }.
  \end{cases}
\end{equation}

为了能更好地描述数据, 常在方差分析中引入总均值与效应的概念. 称诸 $\mu_i$ 的平均（所有试验结果的均值的平均）
\begin{equation}
  \label{eq.8.1.4}
  \mu = \frac{1}{r} (\mu_1 + \cdots + \mu_r) = \frac{1}{r} \sum_{i=1}^{r} \mu_i
\end{equation}
为总均值. 称第 $i$ 水平下的均值 $\mu_i$ 与总均值 $\mu$ 的差
\begin{equation}
  \label{eq:8.1.5}
  a_i = \mu_i - \mu, \quad i = 1,2,\ldots,r
\end{equation}
为因子 $A$ 的第 $i$ 水平的\textbf{主效应}\index{Z!主效应}, 简称为 $A_i$ 的效应. 

容易看出 
% \begin{align}
%   \sum_{i=1}^{r} a_i = 0, \label{eq:8.1.6}\\
%   \mu_i = \mu + a_i, \label{eq:8.1.7}
% \end{align}
\begin{equation}
  \label{eq:8.1.6}
  \sum_{i=1}^{r} a_i = 0,
\end{equation}
\begin{equation}
  \label{eq:8.1.7}
  \mu_i = \mu + a_i,
\end{equation}
这表明第 $i$ 个总体均值是由总均值与该水平的效应叠加而成的, 从而模型~(\ref{eq:8.1.3}) 可以改写为
\begin{equation}
  \label{eq:8.1.8}
  \begin{cases}
    y_{ij}  = \mu + a_i + \varepsilon_{ij}, \quad i = 1,2,\ldots,r,\; j = 1,2,\ldots,m; \\
    \sum\limits_{i=1}^{r} a_i = 0; \\
    \text{$\varepsilon_{ij}$ 相互独立, 且都服从 $N(0,\sigma^2)$ }.
  \end{cases}
\end{equation}
假设~(\ref{eq:8.1.1}) 可改写为 
\begin{equation}
  H_0 \textrm{ : } a_1 = a_2 = \cdots = a_r,\label{eq:8.1.9}
\end{equation}
其备择假设为
\begin{equation*}
  H_1 \text{ : } a_1,a_2,\ldots,a_r \text{ 不全为 0.}
\end{equation*}

\subsection{平方和分解}\label{ssec:8.1.3}
\subsubsection{试验数据}

通常在单因子方差分析中可将试验数据列成如下表格形式. 

% Table generated by Excel2LaTeX from sheet 'Sheet1'
\begin{table}[htbp]
  \centering
  \caption{单因子方差分析试验数据}
    \begin{tabular}{ccccccccc}
    \toprule
    因子水平  &       & \multicolumn{4}{c}{试验数据}      &       & 和     & 平均 \\
    \midrule
    $A_1$    &       & $y_{11}$   & $y_{12}$   & $\cdots$ & $y_{1m}$   &       & $T_1$    & $\bar{y}_{1}$ \\
    $A_2$    &       & $y_{21}$   & $y_{22}$   & $\cdots$  & $y_{2m}$   &       & $T_2$    & $\bar{y}_{2}$ \\
    $\vdots$ &       & $\vdots$    & $\vdots$   &       &   $\vdots$  &       &  $\vdots$   & $\vdots$ \\
    $A_r$    &       & $y_{r1}$   & $y_{r2}$   & $\cdots$   & $y_{rm}$   &       & $T_r$    & $\bar{y}_{r}$ \\
    \midrule
          &       &       &       &       &       &       & $T$     & $\bar{y}$ \\
    \bottomrule
    \end{tabular}%
  \label{tab:8.1.2}%
\end{table}%
\ref{tab:8.1.2} 中的最后二列的和与平均的含义如下：
\begin{align*}
  T_i &= \sum_{j=1}^{m} y_{ij},\; \bar{y}_i = \frac{T_i}{m} \quad i =1,2,\ldots,r,\\
  T_i & = \sum_{i=1}^{r} T_{i},\; \bar{y} = \frac{T}{r \cdot m} = \frac{T}{n},\\
  n & = r \cdot m = \text{ 总试验次数 }.
\end{align*}

\subsubsection{组内偏差与组间偏差}

数据间是有差异的. 数据 $y_{ij}$ 与总平均 $\bar{y}$ 间的偏差可用 $y_{ij} - \bar{y}$ 表示, 它可分解为两个偏差之和
\begin{equation}\label{eq:8.1.10}
  y_{ij}-\bar{y}=(y_{ij}-\bar{y}_{i.})+(\bar{y}_{i.}-\bar{y})
\end{equation}
记
\begin{equation*}
  \bar{\varepsilon}_{i.} =\frac{1}{m} \sum_{j=1}^{m} \varepsilon_{ij}, \quad \bar{\varepsilon}=\frac{1}{r} \sum_{i=1}^{r} \bar{\varepsilon}_{i} = \frac{1}{n} \sum_{i=1}^{r} \sum_{j=1}^{m} \varepsilon_{ij}.
\end{equation*}
由于
\begin{equation}\label{eq:8.1.11}
  y_{i j}-\bar{y}_{i.}=(\mu_{i}+\varepsilon_{i j})-(\mu_{i}+\bar{\varepsilon}_{i})=\varepsilon_{i j}-\bar{\varepsilon}_{i},
\end{equation}
所以 $y_{ij} - \bar{y}_{i.}$ 仅反映组内数据与组内平均的随机误差, 称为\textbf{组内偏差}\index{Z!组内偏差}; 而
\begin{equation}\label{eq:8.1.12}
  \bar{y}_{i.}-\bar{y} = (\mu_{i}+ \bar{\varepsilon}_{i.})-(\mu +\bar{\varepsilon}_{i})= a_i + \bar{\varepsilon}_{i.}-\bar{\varepsilon},
\end{equation}
$\bar{y}_{i.} - \bar{y}$ 除了反映随机误差外，还反映了第 $i$ 个水平的效应，称为组间偏差，

\subsubsection{偏差平方和及其自由度}

在统计学中，把 $k$ 个数据 $y_1,\ldots,y_k$ 分别对其均值 $\bar{y}=(y_1+\cdots+y_{k}) / k$ 的偏差平方和
\begin{equation*}
  Q=\left(y_{1}-\bar{y}\right)^{2}+\cdots+\left(y_{k}-\bar{y}\right)^{2}=\sum_{i=1}^{k}\left(y_{i}-\bar{y}\right)^{2}
\end{equation*}

称为 $k$ 个数据的\textbf{偏差平方和}\index{P!偏差平方和}，有时简称\textbf{平方和}\index{P:平方和}. 偏差平方和常用来度量若干个数据集中或分散的程度，它是用来度量若干个数据间差异（即波动）的大小的一个重要的统计量.

在构成偏差平方和 $Q$ 的 $k$ 个偏差 $y_1 - \bar{y}, \ldots, y_{k} - \bar{y}$ 间有一个恒等式
\begin{equation*}
  \sum_{i=1}^{k}\left(y_{i}-\bar{y}\right)=0
\end{equation*}

这说明在 $Q$ 中独立的偏差只有 $k-1$ 个. 在统计学中把平方和中独立偏差个数称为该平方和的\textbf{自由度}\index{Z:自由度}，常记为 $f$ ，如 $Q$ 的自由度为 $f_{Q}=k-1$. 自由度是偏差平方和的一个重要参数.

\subsubsection{总平方和分解公式}

各 $y_{ij}$ 间总的差异大小可用\textbf{总偏差平方和} $S_T$ 表示，
\begin{equation}\label{eq:8.1.13}
  S_{T}=\sum_{i=1}^{r} \sum_{j=1}^{m}\left(y_{i j}-\bar{y}\right)^{2}, \quad f_{T} = n-1,
\end{equation}

仅由随机误差引起的数据间的差异可以用组内偏差平方和表示，也称为误差偏差平方和，记为 $S_e$
\begin{equation}\label{eq:8.1.14}
  S_{e}=\sum_{i=1}^{r} \sum_{j=1}^{m}\left(y_{i j}-\bar{y}_{i .}\right)^{2}, \quad f_{e}=r(m-1)=n-r.
\end{equation}
由于组间差异除了随机误差外，还反映了效应间的差异，故由效应不同引起的数据差异可用\textbf{组间偏差平方和}表示，也称为因子 $A$ 的\textbf{偏差平方和}，记为 $S_A$；
\begin{equation}\label{eq:8.1.15}
  S_{A}=m \sum_{i=1}^{r}\left(\bar{y}_{i.}-\bar{y}\right)^{2}, \quad f_{A}=r-1
\end{equation}

\begin{theorem}{}{8.1.1}
在上述符号下，总平方和 $S_T$ 可以分解为因子平方和 $S_A$ 与误差平方和 $S_e$。之和，其自由度也有相应分解公式，具体为：
\begin{equation} \label{eq:8.1.16}
S_{T}=S_{A}+ S_{e}, \quad f_{T}=f_{A}+f_{e}
\end{equation}
~\eqref{eq:8.1.16} 式通常称为总平方和分解式. 
\end{theorem}

\begin{proof}
注意到
  \begin{equation*}
    \sum_{i=1}^{r} \sum_{j=1}^{m}(y_{i j}-\bar{y}_{i.})(\bar{y}_{i.}-\bar{y})= \sum_{i=1}^{r}\big[(\bar{y}_{i.}-\bar{y}) \sum_{i=1}^{m}(y_{i j}-\bar{y}_{i.})\big]=0
    \end{equation*}
故有
    \begin{align*}
      S_{T} & =\sum_{i=1}^{r} \sum_{j=1}^{m}(y_{i j}-\bar{y})^{2} = \sum_{i=1}^{r} \sum_{i=1}^{m}[(y_{i j}-\bar{y}_{i.})+(\bar{y}_{i.}-\bar{y})]^{2}\\
      &=S_{e}+S_{A} + 2 \sum_{i=1}^{r} \sum_{j=1}^{m}(y_{i j}-\bar{y}_{i.})+(\bar{y}_{i .}-\bar{y}) = S_{e} + S_{A},
    \end{align*}
诸自由度间的等式是显然的.
\end{proof}

\subsection{检验方法}

偏差平方和 $Q$ 的大小与数据个数（或自由度）有关，一般说来，数据越多，其偏差平方和越大. 为了便于在偏差平方和间进行比较，统计上引入了均方和的概念，它定义为 
\begin{equation*}
  MS=Q/f_Q,
\end{equation*}
其意为平均每个自由度上有多少平方和，它比较好地度量了一组数据的离散程度. 

如今要对因子平方和SA与误差平方和S2之间进行比较，用其均方和
\begin{equation*}
  MS_{A}=S_A / f_A, \quad MS_{e}=S_{e}/f_{e}
\end{equation*}


进行比较更为合理，因为均方和排除了自由度不同所产生的干扰.故用
\begin{equation}
  F = \frac{MS_{A}}{MS_{e}} = \frac{S_A/f_A}{S_e/f_e}
\end{equation}
作为检验 $H_0$ 的统计量，为给出检验拒绝域，我们需要如下定理：

\begin{theorem}{}{8.1.2}
  在单因子方差分析模型~\eqref{eq:8.1.8} 及前述符号下，有
  \begin{enumerate}
    \item $S_{\varepsilon} / \sigma^{2} \sim \chi^{2}(n-r)$, 从而 $E(S_{e})=(n-r) \sigma^{2}$ \label{enum:8.1.2.1}
    \item $E(S_{A})=(r-1) \sigma^{2} + m \sum\limits_{i=1}^{r} a_{i}^{2}$, 进一步, 若 $H_0$ 成立, 则有 $S_{A} / \sigma^{2} \sim \chi^{2}(r-1)$;\label{enum:8.1.2.2} 
    \item $S_A$ 与 $S_e$ 独立 \label{enum:8.1.2.3}.
  \end{enumerate}
\end{theorem}

\begin{proof}
由于~\eqref{eq:8.1.11} 和~\eqref{eq:8.1.14}, $S_{e}=\sum\limits_{i=1}^{r} \sum\limits_{j=1}^{m}(\varepsilon_{i j}-\bar{\varepsilon_{i.}})^{2}$, 在单因子方差分析模型~\eqref{eq:8.1.8} 下, 我们知道, 诸 $\varepsilon_{ij}, \; i=1,2,\ldots,r,\; j=1,2,\ldots,m$ 独立同分布于 $N(0,\sigma^2)$，由定理~\ref{thm:5.4.1} 知，$\tfrac{1}{\sigma^2} \sum\limits_{j=1}^m (\varepsilon_{ij} - \bar{\varepsilon}_{i.})^2$, $i=1,2,\ldots,r$, 相互独立，其共同分布为 $\chi^2(m-1)$，由卡方分布的可加性，有 $\tfrac{S_e}{\sigma^2} \sim \chi^2(n-r)$，这给出 $E(S_e/\sigma^2) = n-r=f_e$, ~\ref{enum:8.1.2.1}得证.

类似地，由~\eqref{eq:8.1.12} 和~\eqref{eq:8.1.15}，有
\begin{equation*}
  S_A =  m \sum_{i=1}^r (a_i + \varepsilon_{i.} - \bar{\varepsilon})^2.
\end{equation*}
由定理~\ref{thm:5.4.1} 知，对每个 $i$，平方和 $\sum\limits_{j=1}^m (\varepsilon_{ij} - \bar{\varepsilon}_{i.})^2$ 与均值 $\bar{\varepsilon}_{i}$ 独立，从而 $\bar{\varepsilon}_{1.}, \bar{\varepsilon}_{2.},\ldots,\bar{\varepsilon}_{r.}$ 与 $S_e$ 独立，而 $S_A$ 只是，$\bar{\varepsilon}_{1.}, \bar{\varepsilon}_{2.},\ldots,\bar{\varepsilon}_{r.}$ 的函数，由此~\ref{enum:8.1.2.3} 得证.

在模型~\ref{eq:8.1.8} 下，$S_A$ 的期望是
\begin{equation*}
  E(S_A) = m \sum_{i=1}^r a^2 + E\big[m\sum_{i=1}^r (\bar{\varepsilon}_{i.} - \bar{\varepsilon})^2\big],
\end{equation*}
由于诸误差均值 $\bar{\varepsilon}_{1.}, \bar{\varepsilon}_{2.},\ldots,\bar{\varepsilon}_{r.}$ 独立同分布于 $N(0, \sigma^2/m)$，从而由诸误差均值组成的偏差平方和除以 $\sigma^2/m$ 服从卡方分布，即
\begin{equation*}
  \frac{1}{\sigma^{2}} \sum_{i=1}^{r} m\left(\bar{\varepsilon}_{i},-\bar{\varepsilon}\right)^{2}-\chi^{2}(r-1).
\end{equation*}
于是， $E\big[\sum\limits_{i=1}^r m(\bar{\varepsilon}_{i.} - \bar{\varepsilon})\big]$ 在 $H_0$ 成立下，$S_A/\sigma^2 \sim \chi^2(r-1)$, 这就完成了~\ref{enum:8.1.2.2} 的证明.
\end{proof}

由定理`\ref{thm:8.1.2} 知，若 $H_0$ 成立，则 \eqref{eq:8.1.17} 定义的检验统计量 $F$ 服从自由度为 $f_A$ 和 $f_e$ 的 $F$ 分布，因此，由假设检验的一般理论，拒绝域为

\begin{equation}\label{eq:8.1.18}
W =\abs{F \geq F_{1-\alpha}(f_{A}, f_{e})} .
\end{equation}

通常将上述计算过程列成一张表格，称为方差分析表，见表~\ref{tab:8.1.3}

\begin{table}[htbp]
\centering
\caption{单因子方差分析表\label{tab:8.1.3}}
\begin{tabular}{ccccc}
\toprule
来源 & 平方和 & 自由度 & 均方和 & $F$ 比\\
\midrule
因子 & $S_A$ & $f_{A} = r-1$ & $MS_{A} = S_{A}/f_A$ & $F = MS_{A}/MS_{e}$ \\
误差 & $S_{e}$ & $f_{e} = n - r$ & $MS_{e} = S_e/f_e$ & \\
\midrule
总和 & $S_{T}$ & $f_{T} = n - 1$ & & \\
\bottomrule 
\end{tabular}
\end{table}

对给定的 $\alpha$，可作如下判断：
\begin{itemize}
\item 如果 $F > F_{1-\alpha}(f_A,f_e)$，则认为因子 $A$ 显著；
\item 若 $F \leq F_{1-\alpha}(f_A, f_e)$，则说明因子 $A$ 不显著.
\end{itemize}
该检验的 $p$ 值也可利用统计软件求出，若以 $Y$ 记服从 $F(f_A,f_e)$ 的随机变量，则检验的 $p$ 值为 $p = P(Y \geq F)$.

经过简单推导，可以给出常用的各偏差平方和的计算公式如下：

\begin{align}
S_T &= \sum_{i=1}^{r}\sum_{j=1}^{m} y_{ij}^2 - \frac{T^2}{n}; \notag\\
S_A &= \frac{1}{m} \sum_{i=1}^{r} T_{i}^2 - \frac{T^2}{n}; \label{eq:8.1.19}\\
S_e &= S_T - S_A \notag
\end{align}

一般可将计算过程列表进行，见下例.

\begin{example}\label{exam:8.1.2}
采用例~\ref{exam:8.1.1} 的数据，由偏差平方和的公式可以看出，对数据作一个线性变换是不影响方差分析的结果的，本例中，我们将原始数据同时减去 $1000$，并用列表的办法给出计算过程：
\end{example}

% Table generated by Excel2LaTeX from sheet 'Sheet1'
\begin{table}[htbp]
  \centering
  \caption{例~\ref{exam:8.1.2} 的计算表}
    \begin{tabular}{rrrrrrrrrrrr}
    \toprule
    \multicolumn{1}{l}{水平} & \multicolumn{8}{c}{数据（原始数据 $-1000$）}                             & \multicolumn{1}{c}{$T_i$} & \multicolumn{1}{c}{$T_i^2$} & \multicolumn{1}{c}{$\sum_{j=1}^{m} y_{ij}^2$} \\
    \midrule
    \multicolumn{1}{l}{$A_1$} & 73    & 9     & 60    & 1     & 2     & 12    & 9     & 28    & 194   & 37636 & 10024 \\
    \multicolumn{1}{l}{$A_2$} & 107   & 92    & -10   & 109   & 90    & 74    & 122   & 1     & 585   & 342225 & 60355 \\
    \multicolumn{1}{l}{$A_3$} & 93    & 29    & 80    & 21    & 22    & 32    & 29    & 48    & 354   & 125316 & 20984 \\
    \midrule
          &       &       &       &       &       &       &       &       & 1133  & 505177 & 91363 \\
    \bottomrule
    \end{tabular}%
  \label{tab:8.1.4}%
\end{table}%

利用~\eqref{eq:8.1.19}，可算得各偏差平方和为：

\begin{align*}
S_T & = 91363 - \frac{1133^2}{24} = 37876.04, && f_T = 24-1=23,\\
S_A &= \frac{505177}{8} - \frac{1133^2}{24} = 9660.08, && f_A = 3 - 1 = 2,\\
S_e &= S_{T} - S_A = 37876.04 - 9660.08 = 28215.96, && f_{e} = 3(8-1)=21.
\end{align*}

把上述诸平方和及其自由度填入方差分析表，并继续计算得到各均方和以及 $F$ 比，见表~\ref{tab:8.1.5}.

% Table generated by Excel2LaTeX from sheet 'Sheet1'
\begin{table}[htbp]
  \centering
  \caption{\ref{exam:8.1.2} 的方差分析表}
    \begin{tabular}{lcccc}
    \toprule
    来源    & 平方和   & 自由度   & 均方和   & $F$ 比 \\
    \midrule
    因子 $A$  & 9660.08 & 2     & 4830.04 & 3.59 \\
    误差 $e$  & 28215.96 & 21    & 1343.62 &  \\
    总和 $T$  & 37876.04 & 23    &       &  \\
    \bottomrule
    \end{tabular}%
  \label{tab:8.1.5}%
\end{table}%



若取 $a=0.05$，则 $F_{0.95} (2, 21)=3.47$，由于 $F=3.59>3.47$，故认为因子 $A$（饲料）是显著的，即三种饲料对鸡的增肥作用有明显的差别.

\subsection{参数估计}

在检验结果为显著时，我们可进一步求出总均值 $\mu$、各主效应 $a_i$ 和误差方差 $\sigma^2$ 的估计.

\subsubsection{点估计}

由模型~\eqref{eq:8.1.8} 知诸 $y_{ij}$ 相互独立，且 $y_{ij}\sim N(\mu+a_i,\sigma^2)$，因此，可使用最大似然方法求出一般平均 $\mu$、各主效应 $a_i$；和误差方差 $\sigma^2$ 的估计.

首先，写出似然函数

\begin{equation*}
  L\left(\mu, a_{1}, \cdots, a_{r}, \sigma^{2}\right) \prod_{i=1}^{r} \prod_{j=1}^{m}\left\{\frac{1}{\sqrt{2 \pi \sigma^{2}}} \exp \left\{-\frac{\left(y_{i j}-\mu-a_{i}\right)^{2}}{2 \sigma^{2}}\right\}\right\}
\end{equation*}
其对数似然函数为
\begin{equation*}
  l\left(\mu, a_{1}, \cdots, a_{r}, \sigma^{2}\right)=-\frac{n}{2} \ln \left(2 \pi \sigma^{2}\right)-\frac{1}{2 \sigma^{2}} \sum_{i=1}^{n} \sum_{i=1}^{m}\left(y_{i j}-\mu-a_{i}\right)^{2}
\end{equation*}

求偏导，得似然方程为
\begin{equation*}
  \begin{cases}
    \frac{\partial l}{\partial \mu} =\frac{1}{2 \sigma^{2}} \sum_{i=1}^{r} \sum_{j=1}^{m}\left(y_{i j}-\mu-a_{i}\right)=0 \\
    \frac{\partial l}{\partial a_{i}} =\frac{1}{2 \sigma^{2}} \sum_{j=1}^{m}\left(y_{i j}-\mu-a_{i}\right)=0, \quad i=1, \cdots, r\\
    \frac{\partial l}{\partial \sigma^{2}} =-\frac{n}{2 \sigma^{2}}+\frac{1}{2 \sigma^{4}} \sum_{i=1}^{m} \sum_{j=1}^{m}\left(y_{i j}-\mu-a_{i}\right)^{2}=0
  \end{cases}
\end{equation*}
考虑到约束条件~\eqref{eq:8.1.8}，可求出前述各参数的最大似然估计为
\begin{equation}
  \label{eq:8.1.20}
  \begin{split}
    \hat{\mu} &= \bar{y}\\
    \hat{a}_{i} & =\bar{y}_{i},-\bar{y}, i=1, \cdots, r \\
    \hat{\sigma}_{M}^{2} &= \frac{1}{n} \sum_{i=1}^{r} \sum_{j=1}^{m}\left(y_{i j}-\bar{y}\right)^{2}=\frac{S_{e}}{n}
  \end{split}
\end{equation}
由最大似然估计的不变性，各水平均值 $\mu_i$ 的最大似然估计为
\begin{equation}
  \label{eq:8.1.21}
  \hat{\mu}_{i}=\bar{y}_{i}
\end{equation}
由于 $\hat{\sigma}_{M}^{2}$ 不是 $\sigma^2$ 的无偏估计，实用中通常采用如下误差方差的无偏估计
\begin{equation}
  \label{eq:8.1.22}
  \hat{\sigma}_{M}^{2} = M S_{e}
\end{equation}

\subsubsection{置信区间}

以下讨论各水平均值 $\mu_i$ 的置信区间. 由定理~\ref{thm:8.1.2} 知 $\bar{y}_{i.} \sim N (\mu_{i}, \sigma^{2}/m)$，且两者独立，故 $S_e/\sigma^2 \sim \chi^2(f_e)$, 且两者独立，故
\begin{equation}
  \frac{\sqrt{m}\left(\bar{y}_{i.}-\mu_{i}\right)}{\sqrt{\mathrm{S}_{0} / f_{0}}} \sim t\left(f_{e}\right)
\end{equation}

由此给出 $A_i$ 的水平均值 $\mu_i$ 的 $1-\alpha$ 的置信区间为
\begin{equation}\label{eq:8.1.23}
  \left[\bar{y}_{i.}-\hat{\sigma} \cdot t_{1-\alpha / 2}(f_{e}) / \sqrt{m}, \bar{y}_{i.}+\hat{\sigma} \cdot t_{1-\alpha / 2}(f_{e}) / \sqrt{m}\right]
\end{equation}
其中 $\tilde{\sigma}^2$ 由~\eqref{eq:8.1.22} 给出.

\begin{example}
我们在~\ref{exam:8.1.2} 中已经指出饲料因子是显著的，此处我们给出诸水平均值的估计.因子 $A$ 的三个水平均值的估计分别为
  \begin{gather*} \hat{\mu}_{1} =1000+\frac{194}{8}=1024.25 \\ 
    \hat{\mu}_{2} =1000+\frac{585}{8}=1073.13 \\ 
    \hat{\mu}_{3} =1000+\frac{354}{8}=1044.25 
  \end{gather*}
从点估计来看，水平 $A_2$（以槐树粉为主的饲料）是最优的.误差方差的无偏估计为
\begin{equation}
  \hat{\sigma}^{2}=M S_{e}=1343.62
\end{equation}
进一步，利用~\ref{eq:8.1.23} 可以给出诸水平均值的置信区间. 此处，$\sigma^2=\sqrt{1343.62}=
36.66$，若取 $a=0.05$，则 $t_{1-\alpha/2} (f_e)=t_{0.975}(21)=2.0796$, $\hat{\sigma} t_{0.975}(21)/\sqrt{8}=26.95$, 于是三个水平均值的 $0.95$ 置信区间分别为
\begin{gather*}
  \mu_{1} : 1024.25 \mp 26.95 = [997.30, 1051.21],\\
  \mu_{2} : 1073.13 \mp 26.95=[1046.18,1100.08],\\
  \mu_{3} : 1044.25 \mp 26.95=[1017.30,1071.21]
\end{gather*}
至此，我们可以看到：在单因子试验的数据分析中可得到如下三个结果：
\begin{itemize}
  \item 因子 $A$ 是否显著：
  \item 试验的误差方差 $\sigma^2$ 的估计；
  \item 诸水平均值 $\mu_i$ 的点估计与区间估计.
\end{itemize}

在因子 $A$ 显著时，通常只需对较优的水平均值作参数估计，在因子 $A$ 不显著场合，参数估计无需进行.
\end{example}
\subsection{重复数不等情形}

有时，每个水平下重复试验次数不全相等，在这最一般情况下进行方差分析与重复数相等情况下的方差分析极为相似，只在几处略有差别.下面我们指出差异之处.
·
\begin{itemize}
  \item 数据
  设从第 $i$ 个水平下的总体获得 $m_i$ 个试验结果，记为 $y_{i1}，y_{i2},\ldots,y_{im_{i}}$, $i=1,2,\ldots,r$, 故总试验次数为 $n=m_1+m_2+\cdots+m_r$, 从而, 其统计模型为：
  \begin{equation}\label{eq:8.1.24}
    \begin{cases}
      y_{i j}=\mu_{i}+\varepsilon_{i v}, \quad i=1,2, \cdots, r, \quad j=1,2, \cdots, m_{i},\\
      \text{各 $\varepsilon_{ij}$ 相互独立，且都服从 $N(0,\sigma^2)$}.
    \end{cases}
  \end{equation}
  \item 总均值
  诸 $\mu_i$ 的加权平均（所有试验结果的均值的平均）
  \begin{equation}\label{eq:8.1.25}
    \mu=\frac{1}{n}\left(m_{1} \mu_{1}+\cdots+m_{n} \mu_{r}\right)=\frac{1}{n} \sum_{i=1}^{r} m_{i j} \mu_{z}
  \end{equation}
  称为总均值.第 $i$ 个水平均值 $\mu_i$ 与总均值 $\mu$ 的差
  \begin{equation}\label{eq:8.1.26}
    a_{i}=\mu_{i}-\mu, \quad i=1,2, \cdots, r
  \end{equation}
  称为因子 $A$ 的第 $i$ 个水平的效应.
  \item 效应约束条件
  由~\eqref{eq:8.1.25} 和~\eqref{eq:8.1.26}，容易看出关于效应的约束条件为
  \begin{equation*}
    \sum_{i=1}^{r} m_{i} a_{i}=0
  \end{equation*}
  且 $\mu_i = \mu + a_i$, 这表明第 $i$ 个总体的均值是由总均值与该水平的效应叠加而成的.类似于~\eqref{eq:8.1.8}，有
  \begin{equation}\label{eq:8.1.27}
    \begin{cases}
      y_{i j}=\mu+a_{i}+\varepsilon_{i j}, \quad i=1,2, \cdots, r, j=1,2, \cdots, m_{i}\\
      \sum_{i=1}^{r} m_{i} a_{i}=0\\
      \text{$\varepsilon_{ij}$ 相互独立，服从 $N(0,\sigma^2)$}.
    \end{cases}
  \end{equation}
  \item 各平方和的计算
  要考虑的问题仍是检验~\eqref{eq:8.1.9} 给出的假设. 整个分析思路与方法基本一样，重要的区别是计算公式稍有不同，特别要注意 $S_A$ 的计算公式. 类似地记
  \begin{gather*}
    T_{i}=\sum_{j=1}^{m_{1}} y_{i j}, \quad \bar{y}_{i},=\frac{T_{i}}{m_{i}} \\
    T=\sum_{i=1}^{r} \sum_{j=1}^{m_{i}} y_{i j}=\sum_{i=1}^{r} T_{i}, \quad \bar{y}=\frac{T}{n}
  \end{gather*}
  则 
  \\begin{equation}
    \label{eq:8.1.28}
    \begin{split}
      S_{T} & =\sum_{i=1}^{r} \sum_{j=1}^{m_{i}}\left(y_{i j}-\overline{y}\right)^{2}=\sum_{i=1}^{r} \sum_{j=1}^{\infty_{i}} y_{i j}^{2}-\frac{T^{2}}{n}, \quad f_{T}=n-1 \\
      S_{A}=\sum_{i=1}^{r} m_{i}\left(\overline{y}_{i} .-\overline{y}\right)^{2}=\sum_{i=1}^{r} \frac{T_{i}^{2}}{m_{i}}-\frac{T^{2}}{n}, \quad f_{A}=r-1 \\
      S_{e}=\sum_{i=1}^{r} \sum_{i=1}^{m_{3}}\left(y_{i j}-\overline{y}_{i}\right)^{2}=S_{T}-S_{A},\quad f_e = n - r
    \end{split}
  \end{equation}
  方差分析表以及参数估计是一样的.
\end{itemize}

\begin{example}\label{exam:8.1.4}
某食品公司对一种食品设计了四种新包装. 为考察哪种包装最受顾客欢迎，选了 10 个地段繁华程度相似、规模相近的商店做试验，其中两种包装各指定两个商店销售，另两个包装各指定三个商店销售.在试验期内各店货架排放的位置、空间都相同，营业员的促销方法也基本相同，经过一段时间，记录其销售量数据，列于表~\ref{tab:8.1.6} 左半边，其相应的计算结果列于右侧. 
% Table generated by Excel2LaTeX from sheet 'Sheet1'
\begin{table}[htbp]
  \centering
  \caption{销售量数据及计算表}
    \begin{tabular}{cccccccc}
    \toprule
    包装类型 & \multicolumn{3}{c}{销售量数据} & $m_i$ & $T_i$ &$T_i^2/m_i$ & $\sum_{j=1}^{m_i} y_{ij}^2$ \\
    \midrule
    \multicolumn{1}{l}{A1} & \multicolumn{1}{r}{12} & \multicolumn{1}{r}{18} &       & 2     & 30    & 450   & 468 \\
    \multicolumn{1}{l}{A2} & \multicolumn{1}{r}{14} & \multicolumn{1}{r}{12} & \multicolumn{1}{r}{13} & 3     & 39    & 507   & 509 \\
    \multicolumn{1}{l}{A3} & \multicolumn{1}{r}{19} & \multicolumn{1}{r}{17} & \multicolumn{1}{r}{21} & 3     & 57    & 1083  & 1091 \\
    \multicolumn{1}{l}{A4} & \multicolumn{1}{r}{24} & \multicolumn{1}{r}{30} &       & 2     & 54    & 1458  & 1476 \\
    \midrule
    \multicolumn{4}{c}{sum}       & 10    & 180   & 3498  & 3544 \\
    \bottomrule
    \end{tabular}%
  \label{tab:8.1.6}%
\end{table}%

由此可求得各类偏差平方和如下 $\left(\frac{T^{2}}{n}=\frac{180^{2}}{10}=3240\right)$.


\begin{align*}
  S_T & = 91363 - \frac{1133^2}{24} = 37876.04, && f_T = 24-1=23,\\
  S_A &= \frac{505177}{8} - \frac{1133^2}{24} = 9660.08, && f_A = 3 - 1 = 2,\\
  S_e &= S_{T} - S_A = 37876.04 - 9660.08 = 28215.96, && f_{e} = 3(8-1)=21.
\end{align*}
方差分析表如表~\ref{tab:8.1.7} 所示.
  
  % Table generated by Excel2LaTeX from sheet 'Sheet1'
  \begin{table}[htbp]
    \centering
    \caption{\ref{exam:8.1.4} 的方差分析表}
      \begin{tabular}{lcccc}
      \toprule
      来源    & 平方和   & 自由度   & 均方和   & $F$ 比 \\
      \midrule
      因子 $A$  & 258 & 3    & 86 & 11.22 \\
      误差 $e$  & 46 & 6    & 7.67 &  \\
      总和 $T$  & 304 & 9    &       &  \\
      \bottomrule
      \end{tabular}%
    \label{tab:8.1.7}%
  \end{table}%
  若取 $\alpha=0.01$，查表得 $F_{0.01}(3,6)=9.78$，由于 $F = 11.22 > 9.78$，故我们可认为各水平间有显著差异.
  
  由于因子显著，我们还可以给出诸水平均值的估计.因子 $A$ 的四个水平均值的估计分别为 
  \begin{gather*}
    \hat{\mu}_{1}=30 / 2=15, \quad \hat{\mu}_{2}=39 / 3=13 \\
    \hat{\mu}_{3}=57 / 3=19, \quad \overline{\mu}_{4}=54 / 2=27
  \end{gather*} 
  由此可见，第四种包装方式效果最好.误差方差的无偏估计为
  \begin{equation*}
    \dot{\sigma}^{2}=M S_{e}=7.67
  \end{equation*}
  进一步，利用~\eqref{eq:8.1.23} 也可以给出诸水平均值的置信区间，只是在这里要用不同的 $m_i$ 代替那里相同的 $m$. 此处，$\hat{\sigma} = \sqrt{7.67}=2.7695$，若取 $\alpha=0.05$，则 $t_{1-a / 2}\left(f_{8}\right)=t_{0.975}(6)=2.4469$, $\hat{\sigma} t_{0.975}(6)=6.7767$，于是效果较好的第三和第四个水平均值的 0.95 置信区间分别为
\begin{gather*}
  \mu_{3} : 19 \pm 6.7767 / \sqrt{3}=[15.09,22.91] \\
  \mu_{4} : 27 \pm 6.7767 / \sqrt{2}=[22.21,31.79]
\end{gather*}
\end{example}

\begin{xiti}
  \item 在一个单因子试验中，因子 $A$ 有三个水平，每个水平下各重复 4 次，具体数据如下：
  % Table generated by Excel2LaTeX from sheet 'Sheet2'
    \begin{tabular}{cccccc}
    水平    &       & \multicolumn{4}{c}{数据} \\
    一水平   &       & 8,    & 5,    & 7,    & 4 \\
    二水平   &       & 6,    & 10,   & 12,   & 9 \\
    三水平   &       & 0,    & 1,    & 5,    & 2 \\
    \end{tabular}%
    试计算误差平方和 $S_e$、因子 $A$ 的平方和 $S_A$、总平方和 $S_T$，并指出它们各自的自由度.
    \item 在一个单因子试验中，因子 $A$ 有 4 个水平，每个水平下重复次数分别为 5, 7, 6, 8. 那
\end{xiti}

\section{多重比较}\label{sec:8.2}

\section{方差齐次检验}\label{sec:8.3}

\section{一元线性回归}\label{sec:8.4}

\section{一元非线性回归}\label{sec:8.5}